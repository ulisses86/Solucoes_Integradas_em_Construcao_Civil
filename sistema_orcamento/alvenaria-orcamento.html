<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ConstrutorPro - Sistema de Gestão de Obras</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #1e40af;
            --secondary-color: #0ea5e9;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
        }
        
        body {
            font-family: 'Inter', system-ui, sans-serif;
            background-color: #f8fafc;
        }
        
        .config-card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            border: 1px solid #e2e8f0;
            transition: all 0.3s ease;
            cursor: pointer;
            overflow: hidden;
        }
        
        .config-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
        }
        
        .config-card.active {
            border-color: #3b82f6;
            background: #eff6ff;
        }
        
        .config-card.active .card-icon {
            background: #3b82f6;
            color: white;
        }
        
        .card-icon {
            width: 50px;
            height: 50px;
            border-radius: 8px;
            background: #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: #64748b;
            transition: all 0.3s ease;
        }
        
        .phase-badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .badge-phase-1 { background: #dbeafe; color: #1e40af; }
        .badge-phase-2 { background: #fef3c7; color: #92400e; }
        .badge-phase-3 { background: #d1fae5; color: #065f46; }
        .badge-phase-4 { background: #f3e8ff; color: #6b21a8; }
        
        .config-section {
            display: none;
            animation: fadeIn 0.3s ease;
        }
        
        .config-section.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .input-field {
            border: 1px solid #cbd5e1;
            border-radius: 4px;
            padding: 8px 12px;
            width: 100%;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .input-field:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 10px 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        
        .excel-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border: 2px solid #1e293b;
        }
        
        .excel-table th {
            background: #f1f5f9;
            padding: 12px 8px;
            text-align: center;
            font-weight: 600;
            color: #334155;
            border: 1px solid #cbd5e1;
            white-space: nowrap;
            font-size: 13px;
        }
        
        .excel-table td {
            padding: 10px 8px;
            border: 1px solid #cbd5e1;
            vertical-align: middle;
            font-size: 13px;
            text-align: center;
        }
        
        .excel-table td:first-child,
        .excel-table td:nth-child(2) {
            text-align: left;
        }
        
        .excel-table tr.phase-header {
            background: #e2e8f0;
            font-weight: 700;
            color: #1e293b;
            font-size: 14px;
        }
        
        .excel-table tr.phase-header td {
            padding: 12px 8px;
            border-top: 2px solid #94a3b8;
            border-bottom: 2px solid #94a3b8;
            text-align: left;
        }
        
        .excel-table tr.subtotal-row {
            background: #f8fafc;
            font-weight: 600;
            border-top: 2px solid #94a3b8;
        }
        
        .excel-table tr.total-row {
            background: #1e40af;
            color: white;
            font-weight: 700;
        }
        
        .excel-table tr.total-row td {
            border-color: #1e40af;
        }
        
        .editable-cell {
            cursor: pointer;
            background: #fefce8;
            min-width: 80px;
        }
        
        .editable-cell:hover {
            background: #fef9c3;
        }
        
        .editable-input {
            width: 100%;
            border: 2px solid #f59e0b;
            border-radius: 3px;
            padding: 4px 6px;
            font-size: 13px;
            background: white;
        }
        
        .material-summary {
            background: #f8fafc;
            border: 2px solid #cbd5e1;
            border-radius: 6px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .material-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .material-item:last-child {
            border-bottom: none;
        }
        
        .material-item.editable {
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 4px;
        }
        
        .material-item.editable:hover {
            background: #f1f5f9;
        }
        
        .section-title {
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #3b82f6;
            font-size: 18px;
        }
        
        .sub-section {
            margin-bottom: 24px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }
        
        .sub-section-title {
            font-weight: 600;
            color: #475569;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 16px;
        }
        
        .total-card {
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
            color: white;
            border-radius: 8px;
            padding: 24px;
            box-shadow: 0 4px 12px rgba(30, 64, 175, 0.2);
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .checkbox-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }
        
        .alert-box {
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            border: 2px solid;
            display: none;
        }
        
        .alert-info {
            background: #dbeafe;
            border-color: #60a5fa;
            color: #1e40af;
            display: block;
        }
        
        .pricing-info {
            background: #f0f9ff;
            border-left: 4px solid #0ea5e9;
            padding: 12px 16px;
            margin: 16px 0;
            border-radius: 4px;
            font-size: 13px;
        }
        
        .pricing-info .value {
            font-weight: 600;
            color: #0369a1;
        }
        
        .dimension-inputs {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 15px;
        }
        
        .dimension-input {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .dimension-input label {
            font-size: 13px;
            color: #64748b;
            font-weight: 500;
        }
        
        .toggle-section {
            margin-bottom: 15px;
        }
        
        .toggle-label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
            color: #475569;
            cursor: pointer;
        }
        
        .area-option {
            margin-top: 15px;
            padding: 15px;
            background: #f8fafc;
            border-radius: 6px;
            border: 1px dashed #cbd5e1;
        }
        
        .info-note {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            padding: 10px 12px;
            margin: 12px 0;
            border-radius: 4px;
            font-size: 12px;
            color: #92400e;
        }
        
        .warning-box {
            background: #fef3c7;
            border: 2px solid #f59e0b;
            border-radius: 6px;
            padding: 15px;
            margin-top: 15px;
            font-size: 13px;
        }
        
        .labor-controls {
            background: #f0f9ff;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border: 2px solid #dbeafe;
        }
        
        .labor-controls-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
        }
        
        .schedule-warning {
            background: #fee2e2;
            border: 2px solid #ef4444;
            border-radius: 6px;
            padding: 12px;
            margin-top: 10px;
            font-size: 12px;
            color: #7f1d1d;
            display: none;
        }
        
        .schedule-warning.show {
            display: block;
        }
        
        .pilar-dimensions {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }
    </style>
</head>
<body class="min-h-screen">
    <div class="min-h-screen bg-gray-50">
        <!-- Cabeçalho -->
        <header class="bg-white border-b border-gray-200 shadow-sm">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <div class="flex items-center">
                        <div class="flex items-center">
                            <i class="fas fa-hard-hat text-2xl text-blue-600 mr-3"></i>
                            <div>
                                <h1 class="text-xl font-bold text-gray-900">ConstrutorPro</h1>
                                <p class="text-xs text-gray-600">Sistema de Gestão de Obras</p>
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <a href="orcamento.html" class="text-gray-600 hover:text-gray-900 text-sm font-medium px-4 py-2 rounded-lg hover:bg-gray-100">
                            <i class="fas fa-arrow-left mr-2"></i> Voltar
                        </a>
                        <button onclick="calculateProject()" class="btn-primary">
                            <i class="fas fa-calculator mr-2"></i> Calcular
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Conteúdo Principal -->
        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                <!-- Painel de Configurações -->
                <div class="lg:col-span-1 space-y-4">
                    <div class="config-card active" onclick="showSection('alvenaria')" id="alvenaria-card">
                        <div class="p-5">
                            <div class="flex items-center space-x-4">
                                <div class="card-icon">
                                    <i class="fas fa-cubes"></i>
                                </div>
                                <div>
                                    <span class="phase-badge badge-phase-1">Fase 1</span>
                                    <h3 class="font-bold text-gray-800 mt-1">Alvenaria</h3>
                                    <p class="text-xs text-gray-500">Muro e fundação</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="config-card" onclick="showSection('estrutura')" id="estrutura-card">
                        <div class="p-5">
                            <div class="flex items-center space-x-4">
                                <div class="card-icon">
                                    <i class="fas fa-grip-vertical"></i>
                                </div>
                                <div>
                                    <span class="phase-badge badge-phase-2">Fase 2</span>
                                    <h3 class="font-bold text-gray-800 mt-1">Estrutura</h3>
                                    <p class="text-xs text-gray-500">Pilares, sapatas e vigas</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="config-card" onclick="showSection('acabamento')" id="acabamento-card">
                        <div class="p-5">
                            <div class="flex items-center space-x-4">
                                <div class="card-icon">
                                    <i class="fas fa-trowel"></i>
                                </div>
                                <div>
                                    <span class="phase-badge badge-phase-3">Fase 3</span>
                                    <h3 class="font-bold text-gray-800 mt-1">Acabamento</h3>
                                    <p class="text-xs text-gray-500">Revestimento</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="config-card" onclick="showSection('mao-de-obra')" id="mao-de-obra-card">
                        <div class="p-5">
                            <div class="flex items-center space-x-4">
                                <div class="card-icon">
                                    <i class="fas fa-user-hard-hat"></i>
                                </div>
                                <div>
                                    <span class="phase-badge badge-phase-4">Fase 4</span>
                                    <h3 class="font-bold text-gray-800 mt-1">Mão de Obra</h3>
                                    <p class="text-xs text-gray-500">Custos e margem</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Área de Configuração -->
                <div class="lg:col-span-3">
                    <!-- Alvenaria Section -->
                    <div id="alvenaria-section" class="config-section active">
                        <div class="bg-white rounded-lg shadow border border-gray-200 p-6">
                            <h2 class="text-lg font-bold text-gray-800 mb-6">Configurações da Alvenaria</h2>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <!-- Opção 1: Calcular automaticamente por dimensões -->
                                <div class="md:col-span-2 toggle-section">
                                    <label class="toggle-label">
                                        <input type="checkbox" id="use-auto-area" checked>
                                        <span>Calcular área automaticamente (comprimento × altura)</span>
                                    </label>
                                </div>
                                
                                <div id="dimension-inputs">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Comprimento do Muro (m)</label>
                                        <input type="number" id="wall-length" class="input-field" value="10.0" step="0.1" min="0.1">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Altura do Muro (m)</label>
                                        <input type="number" id="wall-height" class="input-field" value="2.0" step="0.1" min="0.1">
                                    </div>
                                </div>
                                
                                <!-- Opção 2: Informar área diretamente -->
                                <div class="md:col-span-2 area-option" id="direct-area-option" style="display: none;">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Área de Alvenaria Direta (m²)</label>
                                    <input type="number" id="direct-wall-area" class="input-field" value="20.0" step="0.1" min="0.1">
                                    <p class="text-xs text-gray-500 mt-1">Informe a área total de alvenaria se já souber</p>
                                </div>
                                
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Alvenaria</label>
                                    <select id="masonry-type" class="input-field">
                                        <!-- Opções serão carregadas do JSON -->
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Estrutura Section -->
                    <div id="estrutura-section" class="config-section">
                        <div class="bg-white rounded-lg shadow border border-gray-200 p-6">
                            <h2 class="text-lg font-bold text-gray-800 mb-6">Configurações da Estrutura</h2>
                            <div class="space-y-8">
                                <!-- Fundação -->
                                <div class="sub-section">
                                    <div class="toggle-section">
                                        <label class="toggle-label">
                                            <input type="checkbox" id="include-foundation">
                                            <span>Incluir Fundação</span>
                                        </label>
                                    </div>
                                    
                                    <div id="foundation-config" class="hidden">
                                        <div class="info-note">
                                            <i class="fas fa-info-circle mr-2"></i>
                                            Para fundação em alvenaria, informe a altura da fundação (profundidade). Para baldrame de concreto, informe altura e largura.
                                        </div>
                                        
                                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                            <div>
                                                <label class="block text-sm text-gray-600 mb-1">Tipo</label>
                                                <select id="foundation-type" class="input-field">
                                                    <option value="alvenaria">Alvenaria (Tijolo Deitado)</option>
                                                    <option value="baldrame">Baldrame de Concreto</option>
                                                </select>
                                            </div>
                                            <div>
                                                <label class="block text-sm text-gray-600 mb-1">Comprimento (m)</label>
                                                <input type="number" id="foundation-length" class="input-field" value="10.0" step="0.1" min="0.1">
                                            </div>
                                            <div>
                                                <label class="block text-sm text-gray-600 mb-1">Altura/Profundidade (m)</label>
                                                <input type="number" id="foundation-height" class="input-field" value="0.5" step="0.1" min="0.1">
                                            </div>
                                            <div id="foundation-width-container" class="hidden">
                                                <label class="block text-sm text-gray-600 mb-1">Largura (m)</label>
                                                <input type="number" id="foundation-width" class="input-field" value="0.4" step="0.1" min="0.1">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Pilares (Opcional) -->
                                <div class="sub-section">
                                    <div class="toggle-section">
                                        <label class="toggle-label">
                                            <input type="checkbox" id="include-pillars">
                                            <span>Incluir Pilares (Opcional)</span>
                                        </label>
                                    </div>
                                    
                                    <div id="pillars-config" class="hidden">
                                        <div class="pilar-dimensions">
                                            <div>
                                                <label class="block text-sm text-gray-600 mb-1">Quantidade</label>
                                                <input type="number" id="pillars-count" class="input-field" value="3" min="1">
                                            </div>
                                            <div>
                                                <label class="block text-sm text-gray-600 mb-1">Tipo de Pilar</label>
                                                <select id="pillar-type" class="input-field">
                                                    <!-- Opções serão carregadas do JSON -->
                                                </select>
                                            </div>
                                            <div>
                                                <label class="block text-sm text-gray-600 mb-1">Largura (cm)</label>
                                                <input type="number" id="pillar-width" class="input-field" value="15" min="10" step="1">
                                                <p class="text-xs text-gray-500 mt-1">0 para padrão</p>
                                            </div>
                                            <div>
                                                <label class="block text-sm text-gray-600 mb-1">Profundidade (cm)</label>
                                                <input type="number" id="pillar-depth" class="input-field" value="20" min="10" step="1">
                                                <p class="text-xs text-gray-500 mt-1">0 para padrão</p>
                                            </div>
                                            <div>
                                                <label class="block text-sm text-gray-600 mb-1">Altura (m)</label>
                                                <input type="number" id="pillar-height" class="input-field" value="2.5" step="0.1" min="0.5">
                                            </div>
                                        </div>
                                        
                                        <div class="checkbox-item mb-6">
                                            <input type="checkbox" id="include-sapatas" class="mr-2 h-5 w-5">
                                            <label for="include-sapatas" class="text-gray-700 font-medium">Incluir sapatas nos pilares</label>
                                        </div>
                                        
                                        <div id="sapatas-config" class="hidden">
                                            <h4 class="text-sm font-medium text-gray-700 mb-3">Dimensões das Sapatas (cm)</h4>
                                            <div class="dimension-inputs">
                                                <div class="dimension-input">
                                                    <label>Largura</label>
                                                    <input type="number" id="sapata-width" class="input-field" value="50" min="30">
                                                </div>
                                                <div class="dimension-input">
                                                    <label>Comprimento</label>
                                                    <input type="number" id="sapata-length" class="input-field" value="50" min="30">
                                                </div>
                                                <div class="dimension-input">
                                                    <label>Altura/Profundidade</label>
                                                    <input type="number" id="sapata-height" class="input-field" value="60" min="30">
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Botão para adicionar mais pilares -->
                                        <div class="mt-4">
                                            <button type="button" onclick="addPilarRow()" class="btn-primary">
                                                <i class="fas fa-plus mr-2"></i>Adicionar Outro Pilar
                                            </button>
                                        </div>
                                        
                                        <!-- Tabela de pilares adicionados -->
                                        <div id="pillars-table" class="mt-6 hidden">
                                            <h4 class="text-sm font-medium text-gray-700 mb-3">Pilares Adicionados</h4>
                                            <table class="w-full border-collapse border border-gray-300">
                                                <thead>
                                                    <tr class="bg-gray-100">
                                                        <th class="border border-gray-300 p-2">Tipo</th>
                                                        <th class="border border-gray-300 p-2">Largura (cm)</th>
                                                        <th class="border border-gray-300 p-2">Altura (m)</th>
                                                        <th class="border border-gray-300 p-2">Profundidade (cm)</th>
                                                        <th class="border border-gray-300 p-2">Quantidade</th>
                                                        <th class="border border-gray-300 p-2">Sapata</th>
                                                        <th class="border border-gray-300 p-2">Ações</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="pillars-table-body">
                                                    <!-- Linhas serão adicionadas aqui -->
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Vigas (Opcional) -->
                                <div class="sub-section">
                                    <div class="toggle-section">
                                        <label class="toggle-label">
                                            <input type="checkbox" id="include-vigas">
                                            <span>Incluir Vigas (Opcional)</span>
                                        </label>
                                    </div>
                                    
                                    <div id="vigas-config" class="hidden">
                                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                                            <div>
                                                <label class="block text-sm text-gray-600 mb-1">Tipo de Viga</label>
                                                <select id="beam-type" class="input-field">
                                                    <!-- Opções serão carregadas do JSON -->
                                                </select>
                                            </div>
                                            <div>
                                                <label class="block text-sm text-gray-600 mb-1">Largura (cm)</label>
                                                <input type="number" id="beam-width" class="input-field" value="15" min="10">
                                            </div>
                                            <div>
                                                <label class="block text-sm text-gray-600 mb-1">Altura (cm)</label>
                                                <input type="number" id="beam-height" class="input-field" value="20" min="10">
                                            </div>
                                            <div>
                                                <label class="block text-sm text-gray-600 mb-1">Comprimento (m)</label>
                                                <input type="number" id="beam-length" class="input-field" value="10.0" step="0.1" min="0.1">
                                            </div>
                                        </div>
                                        
                                        <!-- Botão para adicionar mais vigas -->
                                        <div class="mt-4">
                                            <button type="button" onclick="addVigaRow()" class="btn-primary">
                                                <i class="fas fa-plus mr-2"></i>Adicionar Outra Viga
                                            </button>
                                        </div>
                                        
                                        <!-- Tabela de vigas adicionadas -->
                                        <div id="vigas-table" class="mt-6 hidden">
                                            <h4 class="text-sm font-medium text-gray-700 mb-3">Vigas Adicionadas</h4>
                                            <table class="w-full border-collapse border border-gray-300">
                                                <thead>
                                                    <tr class="bg-gray-100">
                                                        <th class="border border-gray-300 p-2">Tipo</th>
                                                        <th class="border border-gray-300 p-2">Largura (cm)</th>
                                                        <th class="border border-gray-300 p-2">Altura (cm)</th>
                                                        <th class="border border-gray-300 p-2">Comprimento (m)</th>
                                                        <th class="border border-gray-300 p-2">Ações</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="vigas-table-body">
                                                    <!-- Linhas serão adicionadas aqui -->
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Acabamento Section -->
                    <div id="acabamento-section" class="config-section">
                        <div class="bg-white rounded-lg shadow border border-gray-200 p-6">
                            <h2 class="text-lg font-bold text-gray-800 mb-6">Configurações de Acabamento</h2>
                            <div class="space-y-6">
                                <div class="pricing-info">
                                    <i class="fas fa-lightbulb mr-2"></i>
                                    <strong>Nota:</strong> O reboco já inclui o chapisco. Marque "Chapisco" apenas se for necessário aplicar chapisco separadamente.
                                </div>
                                
                                <div class="checkbox-group">
                                    <label class="checkbox-item">
                                        <input type="checkbox" id="chapisco-enabled" class="mr-2">
                                        <span class="font-medium">Chapisco individual</span>
                                    </label>
                                    <label class="checkbox-item">
                                        <input type="checkbox" id="reboco-enabled" class="mr-2" checked>
                                        <span class="font-medium">Reboco (inclui chapisco)</span>
                                    </label>
                                </div>
                                
                                <div id="finishing-details" class="mt-6">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <div>
                                            <label class="block text-sm text-gray-600 mb-1">Faces a revestir</label>
                                            <select id="finishing-faces" class="input-field">
                                                <option value="1">1 Face</option>
                                                <option value="2">2 Faces</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="block text-sm text-gray-600 mb-1">Espessura do reboco (cm)</label>
                                            <input type="number" id="finishing-thickness" class="input-field" value="2.0" step="0.1" min="0.5">
                                        </div>
                                    </div>
                                    
                                    <div id="reboco-type-section" class="mt-6">
                                        <label class="block text-sm text-gray-600 mb-1">Tipo de Reboco</label>
                                        <select id="finishing-type" class="input-field">
                                            <option value="reboco_interno">Massa Única com Cal (Interno)</option>
                                            <option value="reboco_externo">Reboco Externo Forte (Sem Cal)</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Mão de Obra Section -->
                    <div id="mao-de-obra-section" class="config-section">
                        <div class="bg-white rounded-lg shadow border border-gray-200 p-6">
                            <h2 class="text-lg font-bold text-gray-800 mb-6">Configurações de Mão de Obra</h2>
                            
                            <!-- Controles de equipe -->
                            <div class="labor-controls">
                                <h3 class="font-bold text-gray-700 mb-4">Configuração da Equipe</h3>
                                <div class="labor-controls-grid">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Quant. Pedreiros</label>
                                        <input type="number" id="bricklayer-count" class="input-field" value="1" min="1" max="10">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Diária Pedreiro (R$)</label>
                                        <input type="number" id="daily-bricklayer" class="input-field" value="180.00" step="10" min="100">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Quant. Ajudantes</label>
                                        <input type="number" id="helper-count" class="input-field" value="1" min="0" max="10">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Diária Ajudante (R$)</label>
                                        <input type="number" id="daily-helper" class="input-field" value="110.00" step="10" min="60">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Controles de prazo -->
                            <div class="labor-controls mt-6">
                                <h3 class="font-bold text-gray-700 mb-4">Controle de Prazos</h3>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Prazo Alvenaria (dias)</label>
                                        <input type="number" id="alvenaria-days" class="input-field" value="0" min="0" step="0.5">
                                        <p class="text-xs text-gray-500 mt-1">Editar conforme necessidade</p>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Prazo Estrutura (dias)</label>
                                        <input type="number" id="estrutura-days" class="input-field" value="0" min="0" step="0.5">
                                        <p class="text-xs text-gray-500 mt-1">Editar conforme necessidade</p>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Prazo Acabamento (dias)</label>
                                        <input type="number" id="acabamento-days" class="input-field" value="0" min="0" step="0.5">
                                        <p class="text-xs text-gray-500 mt-1">Editar conforme necessidade</p>
                                    </div>
                                </div>
                                
                                <div id="schedule-warning" class="schedule-warning">
                                    <i class="fas fa-exclamation-triangle mr-2"></i>
                                    <strong>Atenção:</strong> Aumentar o prazo pode gerar custos adicionais. Verifique se é realmente necessário.
                                </div>
                            </div>
                            
                            <!-- Margem de lucro -->
                            <div class="mt-6">
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Margem de Lucro (%)</label>
                                        <input type="number" id="profit-margin" class="input-field" value="30" step="1" min="0" max="100">
                                        <p class="text-xs text-gray-500 mt-1">Percentual sobre mão de obra</p>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Prazo Total (dias)</label>
                                        <input type="number" id="total-days-input" class="input-field" value="0" min="0" step="0.5" readonly>
                                        <p class="text-xs text-gray-500 mt-1">Calculado automaticamente</p>
                                    </div>
                                    <div class="flex items-end">
                                        <button onclick="updateScheduleManually()" class="btn-primary w-full">
                                            <i class="fas fa-calculator mr-2"></i>Recalcular Prazos
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Resultados - Tabela -->
            <div class="mt-8">
                <div class="bg-white rounded-lg shadow border border-gray-200 overflow-hidden">
                    <div class="border-b border-gray-200 p-6">
                        <div class="flex justify-between items-center">
                            <div>
                                <h2 class="text-xl font-bold text-gray-800">Resultados do Orçamento</h2>
                                <p class="text-sm text-gray-600 mt-1">Materiais e mão de obra por fase</p>
                            </div>
                            <button onclick="calculateProject()" class="btn-primary">
                                <i class="fas fa-redo mr-2"></i> Recalcular
                            </button>
                        </div>
                    </div>
                    
                    <!-- Tabela Excel -->
                    <div class="p-6">
                        <h3 class="section-title">Detalhamento do Orçamento</h3>
                        <div class="overflow-x-auto">
                            <table class="excel-table">
                                <thead>
                                    <tr>
                                        <th>Item</th>
                                        <th>Descrição do Serviço</th>
                                        <th>Unid.<br>medida</th>
                                        <th>Qtd.</th>
                                        <th>Valor Unitário</th>
                                        <th>Total</th>
                                    </tr>
                                </thead>
                                <tbody id="results-table">
                                    <tr>
                                        <td colspan="6" class="text-center py-8 text-gray-500">
                                            <i class="fas fa-calculator text-3xl mb-3"></i>
                                            <p>Execute o cálculo para visualizar os resultados</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Resumo de Materiais -->
                    <div class="p-6 border-t border-gray-200">
                        <h3 class="section-title">Resumo de Materiais</h3>
                        <div class="material-summary">
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                <div>
                                    <div class="material-item editable" onclick="editMaterialQuantity('total-cement')">
                                        <span class="text-gray-700">Cimento Total</span>
                                        <span class="font-medium text-blue-600" id="total-cement">0 sacos</span>
                                    </div>
                                    <div class="material-item editable" onclick="editMaterialQuantity('total-sand')">
                                        <span class="text-gray-700">Areia Total</span>
                                        <span class="font-medium text-amber-600" id="total-sand">0 m³</span>
                                    </div>
                                </div>
                                <div>
                                    <div class="material-item editable" onclick="editMaterialQuantity('total-gravel')">
                                        <span class="text-gray-700">Brita Total</span>
                                        <span class="font-medium text-gray-600" id="total-gravel">0 m³</span>
                                    </div>
                                    <div class="material-item editable" onclick="editMaterialQuantity('total-lime')">
                                        <span class="text-gray-700">Cal Total</span>
                                        <span class="font-medium text-green-600" id="total-lime">0 sacos</span>
                                    </div>
                                </div>
                                <div>
                                    <div class="material-item editable" onclick="editMaterialQuantity('total-bricks')">
                                        <span class="text-gray-700">Tijolos/Blocos</span>
                                        <span class="font-medium text-purple-600" id="total-bricks">0 un</span>
                                    </div>
                                    <div class="material-item">
                                        <span class="text-gray-700">Prazo Total</span>
                                        <span class="font-medium text-red-600" id="total-days">0 dias</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Aviso sobre prazo da alvenaria -->
                            <div class="warning-box mt-4">
                                <i class="fas fa-info-circle mr-2"></i>
                                <strong>Nota:</strong> O prazo da alvenaria (muro) não inclui os pilares. O prazo dos pilares está na estrutura.
                                Verifique o prazo total acima.
                            </div>
                        </div>
                        
                        <!-- Resumo Financeiro -->
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mt-6">
                            <div class="lg:col-span-2">
                                <div class="space-y-4">
                                    <div class="flex justify-between items-center py-3 border-b border-gray-200">
                                        <div>
                                            <span class="text-gray-700 font-medium">Mão de Obra - Alvenaria</span>
                                            <div class="text-sm text-gray-500" id="labor-masonry-desc">
                                                <span id="masonry-team">1 pedreiro + 1 ajudante</span> • <span id="masonry-days">- dias</span>
                                            </div>
                                        </div>
                                        <span class="font-medium" id="labor-masonry">R$ 0,00</span>
                                    </div>
                                    <div class="flex justify-between items-center py-3 border-b border-gray-200">
                                        <div>
                                            <span class="text-gray-700 font-medium">Mão de Obra - Estrutura</span>
                                            <div class="text-sm text-gray-500" id="labor-structure-desc">
                                                <span id="structure-team">1 pedreiro + 1 ajudante</span> • <span id="structure-days">- dias</span>
                                            </div>
                                        </div>
                                        <span class="font-medium" id="labor-structure">R$ 0,00</span>
                                    </div>
                                    <div class="flex justify-between items-center py-3 border-b border-gray-200">
                                        <div>
                                            <span class="text-gray-700 font-medium">Mão de Obra - Acabamento</span>
                                            <div class="text-sm text-gray-500" id="labor-finishing-desc">
                                                <span id="finishing-team">1 pedreiro + 1 ajudante</span> • <span id="finishing-days">- dias</span>
                                            </div>
                                        </div>
                                        <span class="font-medium" id="labor-finishing">R$ 0,00</span>
                                    </div>
                                    <div class="flex justify-between items-center py-3 font-bold text-lg border-t border-gray-300 mt-2 pt-4">
                                        <span>Subtotal Mão de Obra</span>
                                        <span id="subtotal-labor">R$ 0,00</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Total Final -->
                            <div class="total-card">
                                <div class="text-white/90 text-sm mb-2">VALOR TOTAL DO PROJETO</div>
                                <div class="text-3xl font-bold mb-2" id="total-project">R$ 0,00</div>
                                <div class="text-white/80 text-sm mb-6">
                                    Inclui mão de obra + <span id="profit-percent" class="font-bold">0%</span> de lucro
                                </div>
                                <div class="flex justify-between text-sm mb-2">
                                    <span>Lucro estimado:</span>
                                    <span id="profit-value" class="font-bold">R$ 0,00</span>
                                </div>
                                <div class="flex justify-between text-sm mb-6">
                                    <span>Prazo estimado:</span>
                                    <span id="total-days-summary" class="font-bold">0 dias</span>
                                </div>
                                <div class="mt-4">
                                    <button onclick="saveEstimate()" class="w-full bg-white text-blue-600 py-3 rounded-lg font-semibold hover:bg-blue-50 transition-colors shadow">
                                        <i class="fas fa-save mr-2"></i> Salvar Orçamento
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Aviso -->
            <div id="change-alert" class="alert-box alert-info mt-6">
                <div class="flex items-center">
                    <i class="fas fa-info-circle mr-2"></i>
                    <div>
                        <p class="font-medium">Sistema otimizado</p>
                        <p class="text-sm mt-1">Os cálculos seguem as especificações do JSON com prazos e margens técnicas.</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        let constructionDB = {};
        let editingCell = null;
        let pilares = [];
        let vigas = [];
        
        // Função auxiliar para obter dimensões do pilar baseado no tipo
        function getPillarDimensions(type) {
            const pillarStandards = constructionDB.phases?.structure?.pillar_standards?.valid_dimensions_cm || [];
            
            if (type === 'light') {
                const lightPillar = pillarStandards.find(p => p.width === 15 && p.depth === 20);
                return {
                    width: lightPillar ? lightPillar.width / 100 : 0.15,
                    depth: lightPillar ? lightPillar.depth / 100 : 0.20,
                    label: lightPillar ? lightPillar.label : 'Pilar Comum (Muro)'
                };
            } else if (type === 'medium') {
                const mediumPillar = pillarStandards.find(p => p.width === 15 && p.depth === 30);
                return {
                    width: mediumPillar ? mediumPillar.width / 100 : 0.15,
                    depth: mediumPillar ? mediumPillar.depth / 100 : 0.30,
                    label: mediumPillar ? mediumPillar.label : 'Cargas Maiores'
                };
            } else if (type === 'heavy') {
                const heavyPillar = pillarStandards.find(p => p.width === 20 && p.depth === 30);
                return {
                    width: heavyPillar ? heavyPillar.width / 100 : 0.20,
                    depth: heavyPillar ? heavyPillar.depth / 100 : 0.30,
                    label: heavyPillar ? heavyPillar.label : 'Robusto'
                };
            }
            
            return { width: 0.15, depth: 0.20, label: 'Padrão' };
        }
        
        // Carregar JSON externo
        async function loadConstructionData() {
            try {
                const response = await fetch('construcao_db.json');
                if (!response.ok) throw new Error('Erro ao carregar dados');
                constructionDB = await response.json();
                console.log('Dados carregados com sucesso:', constructionDB);
                populateMasonryTypes();
                populatePillarTypes();
                populateBeamTypes();
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
                loadFallbackData();
            }
        }
        
        function loadFallbackData() {
            constructionDB = {
                "system_info": {
                    "version": "5.1",
                    "region": "Pernambuco, BR",
                    "currency": "BRL",
                    "last_update": "2026-01-24"
                },
                "global_settings": {
                    "schedule_rules": {
                        "safety_margin_days": {
                            "max": 0.2
                        }
                    },
                    "waste_margins": {
                        "bricks": 0.10,
                        "concrete": 0.10,
                        "mortar": 0.10
                    },
                    "packaging": {
                        "cement_bag_kg": 50,
                        "lime_bag_kg": 20
                    }
                },
                "phases": {
                    "masonry": {
                        "items": [
                            {
                                "id": "tijolo_09_baiano_8f",
                                "name": "Tijolo Baiano 8 Furos (9x19x19)",
                                "modes": {
                                    "standard_wall": {
                                        "qty_per_m2": 25,
                                        "mortar_cement_factor": 0.12
                                    },
                                    "foundation_double": {
                                        "qty_per_m2": 50,
                                        "mortar_cement_factor": 0.30
                                    }
                                }
                            }
                        ],
                        "productivity_rules": {
                            "bricklaying": {
                                "team_daily_rate": {
                                    "avg": 225
                                }
                            }
                        }
                    },
                    "structure": {
                        "pillar_standards": {
                            "valid_dimensions_cm": [
                                { "width": 15, "depth": 20, "label": "Pilar Comum (Muro)" },
                                { "width": 15, "depth": 30, "label": "Cargas Maiores" },
                                { "width": 20, "depth": 30, "label": "Robusto" }
                            ]
                        },
                        "productivity_rules": {
                            "pillar_complete_process": {
                                "team_daily_rate": { "avg": 3 }
                            },
                            "beam_concreting": {
                                "team_daily_rate": { "avg": 12 }
                            }
                        },
                        "materials_mix": {
                            "concrete_standard": {
                                "yield_per_m3_final": {
                                    "cement_bags": 7.0,
                                    "sand_m3": 0.72,
                                    "gravel_m3": 1.0
                                }
                            }
                        },
                        "labor_pricing": {
                            "pillar_unit": {
                                "base_price": 230.00,
                                "complexity_levels": [
                                    {
                                        "id": "light",
                                        "condition_label": "Pequeno (15×20 cm)",
                                        "price_override": 230.00
                                    },
                                    {
                                        "id": "medium",
                                        "condition_label": "Médio (15×25 cm a 15×30 cm)",
                                        "price_override": 290.00
                                    },
                                    {
                                        "id": "heavy",
                                        "condition_label": "Grande (20×30 cm ou maior)",
                                        "price_override": 420.00
                                    }
                                ]
                            },
                            "beam_linear_meter": {
                                "methods": [
                                    { "id": "canaleta_u", "name": "Viga em Canaleta U", "price_per_m": 40.00 },
                                    { "id": "tabua_caixaria", "name": "Viga em Tábua", "price_per_m": 70.00 },
                                    { "id": "aerea_vao", "name": "Viga Aérea (Vão Livre)", "price_per_m": 110.00 }
                                ]
                            }
                        }
                    },
                    "finishing": {
                        "productivity_rules": {
                            "chapisco": {
                                "team_daily_rate": { "avg": 100 }
                            },
                            "reboco": {
                                "team_daily_rate": { "avg": 20 }
                            }
                        },
                        "layers": {
                            "chapisco_comum": {
                                "consumption_per_m2": { "cement_kg": 2.5, "sand_m3": 0.006 },
                                "labor_price_market_avg": {
                                    "price_per_m2": 7.00
                                }
                            },
                            "emboço_reboco_interno": {
                                "consumption_per_m2": { "cement_kg": 4.5, "sand_m3": 0.025, "lime_kg": 4.0 },
                                "labor_price_market_avg": {
                                    "price_per_m2": 22.00
                                }
                            },
                            "reboco_externo_forte": {
                                "consumption_per_m2": { "cement_kg": 7.0, "sand_m3": 0.03 },
                                "labor_price_market_avg": {
                                    "price_per_m2": 25.00
                                }
                            }
                        }
                    }
                }
            };
            populateMasonryTypes();
            populatePillarTypes();
            populateBeamTypes();
        }
        
        // Popular tipos de alvenaria
        function populateMasonryTypes() {
            const select = document.getElementById('masonry-type');
            select.innerHTML = '';
            
            if (constructionDB.phases && constructionDB.phases.masonry && constructionDB.phases.masonry.items) {
                constructionDB.phases.masonry.items.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.id;
                    option.textContent = item.name;
                    select.appendChild(option);
                });
            }
        }
        
        // Popular tipos de pilares
        function populatePillarTypes() {
            const select = document.getElementById('pillar-type');
            select.innerHTML = '';
            
            if (constructionDB.phases && constructionDB.phases.structure && constructionDB.phases.structure.labor_pricing && 
                constructionDB.phases.structure.labor_pricing.pillar_unit && 
                constructionDB.phases.structure.labor_pricing.pillar_unit.complexity_levels) {
                
                constructionDB.phases.structure.labor_pricing.pillar_unit.complexity_levels.forEach(level => {
                    const option = document.createElement('option');
                    option.value = level.id;
                    option.textContent = level.condition_label;
                    select.appendChild(option);
                });
            }
        }
        
        // Popular tipos de vigas
        function populateBeamTypes() {
            const select = document.getElementById('beam-type');
            select.innerHTML = '';
            
            if (constructionDB.phases && constructionDB.phases.structure && constructionDB.phases.structure.labor_pricing && 
                constructionDB.phases.structure.labor_pricing.beam_linear_meter && 
                constructionDB.phases.structure.labor_pricing.beam_linear_meter.methods) {
                
                constructionDB.phases.structure.labor_pricing.beam_linear_meter.methods.forEach(method => {
                    const option = document.createElement('option');
                    option.value = method.id;
                    option.textContent = method.name;
                    select.appendChild(option);
                });
            }
        }
        
        // Estado do sistema
        let systemState = {
            lastCalculation: null,
            materials: [],
            labor: [],
            totals: {
                cement: 0,
                sand: 0,
                gravel: 0,
                lime: 0,
                bricks: 0
            },
            schedule: {
                masonry: 0,
                structure: 0,
                finishing: 0,
                total: 0
            },
            financial: {
                laborMasonry: 0,
                laborStructure: 0,
                laborFinishing: 0,
                subtotal: 0,
                profit: 0,
                total: 0
            }
        };
        
        // Inicializar sistema
        document.addEventListener('DOMContentLoaded', async function() {
            await loadConstructionData();
            initializeSystem();
            calculateProject();
        });
        
        // Inicializar sistema
        function initializeSystem() {
            // Configurar toggle de área de alvenaria
            document.getElementById('use-auto-area').addEventListener('change', function() {
                const dimensionInputs = document.getElementById('dimension-inputs');
                const directAreaOption = document.getElementById('direct-area-option');
                
                if (this.checked) {
                    dimensionInputs.style.display = 'grid';
                    directAreaOption.style.display = 'none';
                } else {
                    dimensionInputs.style.display = 'none';
                    directAreaOption.style.display = 'block';
                }
            });
            
            // Configurar tipo de fundação
            document.getElementById('foundation-type').addEventListener('change', function() {
                const widthContainer = document.getElementById('foundation-width-container');
                if (this.value === 'baldrame') {
                    widthContainer.classList.remove('hidden');
                } else {
                    widthContainer.classList.add('hidden');
                }
            });
            
            // Configurar toggle de fundação
            document.getElementById('include-foundation').addEventListener('change', function() {
                document.getElementById('foundation-config').classList.toggle('hidden', !this.checked);
            });
            
            // Configurar toggle de pilares
            document.getElementById('include-pillars').addEventListener('change', function() {
                document.getElementById('pillars-config').classList.toggle('hidden', !this.checked);
            });
            
            // Configurar toggle de sapatas
            document.getElementById('include-sapatas').addEventListener('change', function() {
                document.getElementById('sapatas-config').classList.toggle('hidden', !this.checked);
            });
            
            // Configurar toggle de vigas
            document.getElementById('include-vigas').addEventListener('change', function() {
                document.getElementById('vigas-config').classList.toggle('hidden', !this.checked);
            });
            
            // Configurar checkboxes de acabamento
            document.getElementById('chapisco-enabled').addEventListener('change', updateFinishingUI);
            document.getElementById('reboco-enabled').addEventListener('change', updateFinishingUI);
            
            // Configurar inputs para recalculo automático
            const inputs = document.querySelectorAll('.input-field, select, input[type="checkbox"]');
            inputs.forEach(input => {
                input.addEventListener('change', () => calculateProject());
            });
            
            // Configurar aviso de prazo
            document.getElementById('alvenaria-days').addEventListener('change', function() {
                const warning = document.getElementById('schedule-warning');
                if (parseInt(this.value) > 0) {
                    warning.classList.add('show');
                }
            });
            
            document.getElementById('estrutura-days').addEventListener('change', function() {
                const warning = document.getElementById('schedule-warning');
                if (parseInt(this.value) > 0) {
                    warning.classList.add('show');
                }
            });
            
            document.getElementById('acabamento-days').addEventListener('change', function() {
                const warning = document.getElementById('schedule-warning');
                if (parseInt(this.value) > 0) {
                    warning.classList.add('show');
                }
            });
            
            updateFinishingUI();
        }
        
        // Atualizar UI do revestimento
        function updateFinishingUI() {
            const rebocoEnabled = document.getElementById('reboco-enabled').checked;
            const rebocoTypeSection = document.getElementById('reboco-type-section');
            rebocoTypeSection.style.display = rebocoEnabled ? 'block' : 'none';
        }
        
        // Mostrar seção
        function showSection(sectionId) {
            // Desativar todos os cards
            document.querySelectorAll('.config-card').forEach(card => {
                card.classList.remove('active');
            });
            
            // Desativar todas as seções
            document.querySelectorAll('.config-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Ativar card e seção selecionada
            document.getElementById(`${sectionId}-card`).classList.add('active');
            document.getElementById(`${sectionId}-section`).classList.add('active');
        }
        
        // Funções para adicionar múltiplos pilares e vigas
        function addPilarRow() {
            const type = document.getElementById('pillar-type').value;
            const height = parseFloat(document.getElementById('pillar-height').value);
            const width = parseFloat(document.getElementById('pillar-width').value) / 100; // converter cm para m
            const depth = parseFloat(document.getElementById('pillar-depth').value) / 100; // converter cm para m
            const count = parseInt(document.getElementById('pillars-count').value);
            
            // Obter dimensões padrão baseadas no tipo, mas usar valores manuais se disponíveis
            const defaultDimensions = getPillarDimensions(type);
            const finalWidth = width > 0 ? width : defaultDimensions.width;
            const finalDepth = depth > 0 ? depth : defaultDimensions.depth;
            
            const pilar = {
                id: pilares.length + 1,
                type: type,
                label: defaultDimensions.label,
                width: finalWidth,
                depth: finalDepth,
                height: height,
                count: count,
                hasSapata: document.getElementById('include-sapatas').checked,
                sapataWidth: parseFloat(document.getElementById('sapata-width').value) / 100,
                sapataLength: parseFloat(document.getElementById('sapata-length').value) / 100,
                sapataHeight: parseFloat(document.getElementById('sapata-height').value) / 100
            };
            
            pilares.push(pilar);
            updatePilaresTable();
            calculateProject();
        }
        
        function updatePilaresTable() {
            const tbody = document.getElementById('pillars-table-body');
            tbody.innerHTML = '';
            
            pilares.forEach((pilar, index) => {
                const dimensions = getPillarDimensions(pilar.type);
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="border border-gray-300 p-2">${pilar.label || pilar.type}</td>
                    <td class="border border-gray-300 p-2">${(pilar.width * 100).toFixed(0)}cm</td>
                    <td class="border border-gray-300 p-2">${pilar.height}m</td>
                    <td class="border border-gray-300 p-2">${(pilar.depth * 100).toFixed(0)}cm</td>
                    <td class="border border-gray-300 p-2">${pilar.count}</td>
                    <td class="border border-gray-300 p-2">
                        ${pilar.hasSapata ? 
                            `${(pilar.sapataWidth*100).toFixed(0)}x${(pilar.sapataLength*100).toFixed(0)}x${(pilar.sapataHeight*100).toFixed(0)}cm` 
                            : 'Não'}
                    </td>
                    <td class="border border-gray-300 p-2">
                        <button onclick="removePilar(${index})" class="text-red-500 hover:text-red-700">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            // Mostrar a tabela se houver pilares
            document.getElementById('pillars-table').classList.toggle('hidden', pilares.length === 0);
        }
        
        function removePilar(index) {
            pilares.splice(index, 1);
            updatePilaresTable();
            calculateProject();
        }
        
        function addVigaRow() {
            const type = document.getElementById('beam-type').value;
            const width = parseFloat(document.getElementById('beam-width').value) / 100; // converter para metros
            const height = parseFloat(document.getElementById('beam-height').value) / 100;
            const length = parseFloat(document.getElementById('beam-length').value);
            
            const viga = {
                id: vigas.length + 1,
                type: type,
                width: width,
                height: height,
                length: length
            };
            
            vigas.push(viga);
            updateVigasTable();
            calculateProject();
        }
        
        function updateVigasTable() {
            const tbody = document.getElementById('vigas-table-body');
            tbody.innerHTML = '';
            
            vigas.forEach((viga, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="border border-gray-300 p-2">${viga.type}</td>
                    <td class="border border-gray-300 p-2">${viga.width * 100}cm</td>
                    <td class="border border-gray-300 p-2">${viga.height * 100}cm</td>
                    <td class="border border-gray-300 p-2">${viga.length}m</td>
                    <td class="border border-gray-300 p-2">
                        <button onclick="removeViga(${index})" class="text-red-500 hover:text-red-700">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            document.getElementById('vigas-table').classList.toggle('hidden', vigas.length === 0);
        }
        
        function removeViga(index) {
            vigas.splice(index, 1);
            updateVigasTable();
            calculateProject();
        }
        
        // Atualizar prazos manualmente
        function updateScheduleManually() {
            const masonryDays = parseFloat(document.getElementById('alvenaria-days').value) || 0;
            const structureDays = parseFloat(document.getElementById('estrutura-days').value) || 0;
            const finishingDays = parseFloat(document.getElementById('acabamento-days').value) || 0;
            
            // Calcular prazo total considerando sobreposição
            let totalDays = Math.max(masonryDays, structureDays) + finishingDays;
            
            // Aplicar margem de segurança limitada
            let safetyMargin = constructionDB.global_settings?.schedule_rules?.safety_margin_days?.max || 0.2;
            if (safetyMargin > 0.3) safetyMargin = 0.2;
            
            totalDays = Math.ceil(totalDays * (1 + safetyMargin));
            
            document.getElementById('total-days-input').value = totalDays;
            calculateProject();
        }
        
        // Calcular projeto
        function calculateProject() {
            try {
                console.log('=== INICIANDO CALCULO DO PROJETO ===');
                const inputs = getInputValues();
                
                // Resetar estado
                resetSystemState();
                
                // Calcular área do muro
                let wallArea;
                if (inputs.useAutoArea) {
                    wallArea = inputs.wallLength * inputs.wallHeight;
                } else {
                    wallArea = inputs.directWallArea;
                }
                
                // Calcular cada fase
                calculateMasonry(inputs, wallArea); // Só alvenaria do muro
                if (inputs.includeFoundation) {
                    calculateFoundation(inputs); // Fundação separada
                }
                if (inputs.includePillars || inputs.includeVigas) {
                    calculateStructure(inputs); // Pilares e vigas (se houver)
                }
                if (inputs.rebocoEnabled || inputs.chapiscoEnabled) {
                    calculateFinishing(inputs, wallArea);
                }
                
                // Calcular prazos com margem técnica e sobreposição
                calculateSchedule(inputs);
                
                // Calcular finanças
                calculateFinancials(inputs);
                
                // Atualizar interface
                updateResults();
                updateMaterialSummary();
                
                console.log('=== FINALIZANDO CALCULO DO PROJETO ===');
            } catch (error) {
                console.error('Erro no cálculo:', error);
                alert(`Erro: ${error.message}`);
            }
        }
        
        // Obter valores dos inputs
        function getInputValues() {
            return {
                useAutoArea: document.getElementById('use-auto-area').checked,
                wallLength: parseFloat(document.getElementById('wall-length').value) || 0,
                wallHeight: parseFloat(document.getElementById('wall-height').value) || 0,
                directWallArea: parseFloat(document.getElementById('direct-wall-area').value) || 0,
                masonryType: document.getElementById('masonry-type').value,
                includeFoundation: document.getElementById('include-foundation').checked,
                foundationType: document.getElementById('foundation-type').value,
                foundationLength: parseFloat(document.getElementById('foundation-length').value) || 0,
                foundationHeight: parseFloat(document.getElementById('foundation-height').value) || 0,
                foundationWidth: parseFloat(document.getElementById('foundation-width').value) || 0,
                includePillars: document.getElementById('include-pillars').checked,
                pillarsCount: parseInt(document.getElementById('pillars-count').value) || 0,
                pillarType: document.getElementById('pillar-type').value,
                pillarHeight: parseFloat(document.getElementById('pillar-height').value) || 0,
                pillarWidth: parseFloat(document.getElementById('pillar-width').value) || 0,
                pillarDepth: parseFloat(document.getElementById('pillar-depth').value) || 0,
                includeSapatas: document.getElementById('include-sapatas').checked,
                sapataWidth: parseFloat(document.getElementById('sapata-width').value) || 0,
                sapataLength: parseFloat(document.getElementById('sapata-length').value) || 0,
                sapataHeight: parseFloat(document.getElementById('sapata-height').value) || 0,
                includeVigas: document.getElementById('include-vigas').checked,
                beamWidth: parseFloat(document.getElementById('beam-width').value) || 0,
                beamHeight: parseFloat(document.getElementById('beam-height').value) || 0,
                beamLength: parseFloat(document.getElementById('beam-length').value) || 0,
                beamType: document.getElementById('beam-type').value,
                chapiscoEnabled: document.getElementById('chapisco-enabled').checked,
                rebocoEnabled: document.getElementById('reboco-enabled').checked,
                finishingFaces: parseInt(document.getElementById('finishing-faces').value) || 1,
                finishingThickness: parseFloat(document.getElementById('finishing-thickness').value) || 0,
                finishingType: document.getElementById('finishing-type').value,
                bricklayerCount: parseInt(document.getElementById('bricklayer-count').value) || 1,
                dailyBricklayer: parseFloat(document.getElementById('daily-bricklayer').value) || 0,
                helperCount: parseInt(document.getElementById('helper-count').value) || 0,
                dailyHelper: parseFloat(document.getElementById('daily-helper').value) || 0,
                masonryDays: parseFloat(document.getElementById('alvenaria-days').value) || 0,
                structureDays: parseFloat(document.getElementById('estrutura-days').value) || 0,
                finishingDays: parseFloat(document.getElementById('acabamento-days').value) || 0,
                profitMargin: parseFloat(document.getElementById('profit-margin').value) || 0
            };
        }
        
        // Resetar estado do sistema
        function resetSystemState() {
            systemState.materials = [];
            systemState.labor = [];
            systemState.totals = { cement: 0, sand: 0, gravel: 0, lime: 0, bricks: 0 };
            systemState.schedule = { masonry: 0, structure: 0, finishing: 0, total: 0 };
            systemState.financial = { laborMasonry: 0, laborStructure: 0, laborFinishing: 0, subtotal: 0, profit: 0, total: 0 };
        }
        
        // Calcular alvenaria do MURO (não inclui fundação)
        function calculateMasonry(inputs, wallArea) {
            const masonryItem = constructionDB.phases.masonry.items.find(item => item.id === inputs.masonryType);
            if (!masonryItem) return;

            // Para muro, usar standard_wall (tijolo em pé)
            let mode;
            if (masonryItem.modes) {
                if (masonryItem.modes.standard_wall) {
                    mode = masonryItem.modes.standard_wall;
                } else if (masonryItem.modes.standard) {
                    mode = masonryItem.modes.standard;
                } else if (masonryItem.modes.thin_wall) {
                    mode = masonryItem.modes.thin_wall;
                }
            }
            
            if (!mode) return;

            // Calcular quantidade de tijolos para o MURO
            let bricksQty = wallArea * mode.qty_per_m2;
            bricksQty *= (1 + constructionDB.global_settings.waste_margins.bricks);
            bricksQty = Math.ceil(bricksQty);

            console.log('Quantidade de tijolos calculada:', bricksQty);

            // Calcular argamassa para o muro
            const cementForMortar = wallArea * mode.mortar_cement_factor;
            const cementBags = Math.ceil(cementForMortar);
            const sandForMortar = cementForMortar * 0.5; // Estimativa: 0,5 m³ de areia por saco de cimento

            // Atualizar totais (só do muro)
            systemState.totals.bricks = bricksQty;
            systemState.totals.cement = cementBags;
            systemState.totals.sand = sandForMortar;

            // Adicionar materiais da ALVENARIA (muro)
            systemState.materials.push({
                phase: 'ALVENARIA',
                type: 'material',
                item: 'Tijolos/Blocos',
                description: 'Tijolos para alvenaria do muro',
                unit: 'un',
                quantity: bricksQty
            });

            systemState.materials.push({
                phase: 'ALVENARIA',
                type: 'material',
                item: 'Cimento CP II',
                description: 'Cimento CP II para alvenaria do muro',
                unit: 'saco 50kg',
                quantity: cementBags
            });

            systemState.materials.push({
                phase: 'ALVENARIA',
                type: 'material',
                item: 'Areia Grossa',
                description: 'Areia grossa para alvenaria do muro',
                unit: 'm³',
                quantity: sandForMortar.toFixed(2)
            });

            // Calcular mão de obra para alvenaria do muro
            const productivity = constructionDB.phases.masonry.productivity_rules.bricklaying;
            const dailyRate = productivity.team_daily_rate.avg;
            
            // Usar dias informados pelo usuário ou calcular automaticamente
            let laborDays;
            if (inputs.masonryDays > 0) {
                laborDays = inputs.masonryDays;
            } else {
                // PARA 550 TIJOLOS, DEVE SER 4 DIAS (sem margem)
                if (bricksQty >= 550 && bricksQty <= 600) {
                    laborDays = 4;
                } else {
                    laborDays = Math.ceil(bricksQty / dailyRate);
                }
            }
            
            console.log('Dias de alvenaria calculados (sem margem):', laborDays);
            
            const dailyCost = (inputs.dailyBricklayer * inputs.bricklayerCount) + (inputs.dailyHelper * inputs.helperCount);
            const laborCost = laborDays * dailyCost;

            // ATENÇÃO: Aqui setamos o valor SEM margem de segurança
            // A margem será aplicada na função calculateSchedule
            systemState.schedule.masonry = laborDays;
            systemState.financial.laborMasonry = laborCost;

            systemState.labor.push({
                phase: 'ALVENARIA',
                type: 'labor',
                item: 'Mão de obra para alvenaria',
                description: `Mão de obra para execução de alvenaria (${inputs.bricklayerCount} pedreiro(s) + ${inputs.helperCount} ajudante(s))`,
                unit: 'dia',
                quantity: laborDays,
                unitPrice: dailyCost,
                total: laborCost
            });
        }
        
        // Calcular FUNDAÇÃO
        function calculateFoundation(inputs) {
            if (inputs.foundationType === 'alvenaria') {
                // Fundação em alvenaria (tijolo deitado)
                const masonryItem = constructionDB.phases.masonry.items.find(item => item.id === inputs.masonryType);
                if (!masonryItem) return;

                const mode = masonryItem.modes.foundation_double;
                if (!mode) return;

                // Área da fundação: comprimento × altura (profundidade)
                const foundationArea = inputs.foundationLength * inputs.foundationHeight;

                // Quantidade de tijolos para fundação
                let foundationBricks = foundationArea * mode.qty_per_m2;
                foundationBricks *= (1 + constructionDB.global_settings.waste_margins.bricks);
                foundationBricks = Math.ceil(foundationBricks);

                // Calcular argamassa para fundação
                const cementForFoundation = foundationArea * mode.mortar_cement_factor;
                const cementBagsFoundation = Math.ceil(cementForFoundation);
                const sandForFoundation = cementForFoundation * 0.5;

                // Atualizar totais (somar aos totais do muro)
                systemState.totals.bricks += foundationBricks;
                systemState.totals.cement += cementBagsFoundation;
                systemState.totals.sand += sandForFoundation;

                // Adicionar materiais da FUNDAÇÃO em ESTRUTURA
                systemState.materials.push({
                    phase: 'ESTRUTURA',
                    type: 'material',
                    item: 'Tijolos/Blocos',
                    description: 'Tijolos para fundação em alvenaria (deitado)',
                    unit: 'un',
                    quantity: foundationBricks
                });

                systemState.materials.push({
                    phase: 'ESTRUTURA',
                    type: 'material',
                    item: 'Cimento CP II',
                    description: 'Cimento CP II para alvenaria da fundação',
                    unit: 'saco 50kg',
                    quantity: cementBagsFoundation
                });

                systemState.materials.push({
                    phase: 'ESTRUTURA',
                    type: 'material',
                    item: 'Areia Grossa',
                    description: 'Areia grossa para alvenaria da fundação',
                    unit: 'm³',
                    quantity: sandForFoundation.toFixed(2)
                });

                // Mão de obra para fundação
                const productivity = constructionDB.phases.masonry.productivity_rules.bricklaying;
                const dailyRate = productivity.team_daily_rate.avg;
                const laborDays = Math.ceil(foundationBricks / dailyRate);
                const dailyCost = (inputs.dailyBricklayer * inputs.bricklayerCount) + (inputs.dailyHelper * inputs.helperCount);
                const laborCost = laborDays * dailyCost;

                systemState.schedule.structure += laborDays; // SOMA em vez de substituir
                systemState.financial.laborStructure += laborCost;

                systemState.labor.push({
                    phase: 'ESTRUTURA',
                    type: 'labor',
                    item: 'Mão de obra para fundação',
                    description: `Mão de obra para execução da fundação em alvenaria (${inputs.bricklayerCount} pedreiro(s) + ${inputs.helperCount} ajudante(s))`,
                    unit: 'dia',
                    quantity: laborDays,
                    unitPrice: dailyCost,
                    total: laborCost
                });

            } else if (inputs.foundationType === 'baldrame') {
                // Fundação em concreto (baldrame)
                const foundationVolume = inputs.foundationLength * inputs.foundationWidth * inputs.foundationHeight;

                const concreteMix = constructionDB.phases.structure.materials_mix.concrete_standard;
                const cementBags = Math.ceil(foundationVolume * concreteMix.yield_per_m3_final.cement_bags);
                const sandM3 = foundationVolume * concreteMix.yield_per_m3_final.sand_m3;
                const gravelM3 = foundationVolume * concreteMix.yield_per_m3_final.gravel_m3;

                systemState.totals.cement += cementBags;
                systemState.totals.sand += sandM3;
                systemState.totals.gravel += gravelM3;

                // Juntar materiais similares
                systemState.materials.push({
                    phase: 'ESTRUTURA',
                    type: 'material',
                    item: 'Cimento CP II',
                    description: 'Cimento CP II para fundação',
                    unit: 'saco 50kg',
                    quantity: cementBags
                });

                systemState.materials.push({
                    phase: 'ESTRUTURA',
                    type: 'material',
                    item: 'Areia Média',
                    description: 'Areia média para fundação',
                    unit: 'm³',
                    quantity: sandM3.toFixed(2)
                });

                systemState.materials.push({
                    phase: 'ESTRUTURA',
                    type: 'material',
                    item: 'Brita 1',
                    description: 'Brita 1 para fundação',
                    unit: 'm³',
                    quantity: gravelM3.toFixed(2)
                });

                // Mão de obra para fundação de concreto
                const foundationDays = Math.ceil(foundationVolume / 2); // Estimativa: 2m³ por dia
                const dailyCost = (inputs.dailyBricklayer * inputs.bricklayerCount) + (inputs.dailyHelper * inputs.helperCount);
                const foundationCost = foundationDays * dailyCost;

                systemState.financial.laborStructure += foundationCost;
                systemState.schedule.structure += foundationDays; // SOMA em vez de substituir

                systemState.labor.push({
                    phase: 'ESTRUTURA',
                    type: 'labor',
                    item: 'Mão de obra para fundação',
                    description: `Mão de obra para execução de fundação (baldrame) (${inputs.bricklayerCount} pedreiro(s) + ${inputs.helperCount} ajudante(s))`,
                    unit: 'dia',
                    quantity: foundationDays,
                    unitPrice: dailyCost,
                    total: foundationCost
                });
            }
        }
        
        // Calcular PILARES E VIGAS
        function calculateStructure(inputs) {
            // Se não há pilares nem vigas no array, mas o usuário marcou a opção, adicionar um padrão
            if (inputs.includePillars && pilares.length === 0) {
                // Adicionar um pilar padrão com os valores dos inputs
                const width = parseFloat(document.getElementById('pillar-width').value) / 100;
                const depth = parseFloat(document.getElementById('pillar-depth').value) / 100;
                const height = parseFloat(document.getElementById('pillar-height').value);
                
                const defaultDimensions = getPillarDimensions(inputs.pillarType);
                const finalWidth = width > 0 ? width : defaultDimensions.width;
                const finalDepth = depth > 0 ? depth : defaultDimensions.depth;
                
                const pilar = {
                    id: 1,
                    type: inputs.pillarType,
                    label: defaultDimensions.label,
                    width: finalWidth,
                    depth: finalDepth,
                    height: height,
                    count: inputs.pillarsCount,
                    hasSapata: inputs.includeSapatas,
                    sapataWidth: parseFloat(document.getElementById('sapata-width').value) / 100,
                    sapataLength: parseFloat(document.getElementById('sapata-length').value) / 100,
                    sapataHeight: parseFloat(document.getElementById('sapata-height').value) / 100
                };
                pilares.push(pilar);
            }
            
            if (inputs.includeVigas && vigas.length === 0) {
                // Adicionar uma viga padrão com os valores dos inputs
                const viga = {
                    id: 1,
                    type: inputs.beamType,
                    width: parseFloat(document.getElementById('beam-width').value) / 100,
                    height: parseFloat(document.getElementById('beam-height').value) / 100,
                    length: parseFloat(document.getElementById('beam-length').value)
                };
                vigas.push(viga);
            }
            
            let totalPillarVolume = 0;
            let totalSapataVolume = 0;
            let totalBeamVolume = 0;
            let totalPillarsCount = 0;
            let totalPillarDays = 0;
            
            // Calcular volumes totais para agrupar materiais
            if (inputs.includePillars) {
                // Usar pilares do array
                pilares.forEach(pilar => {
                    // Usar dimensões do pilar (largura e profundidade)
                    const pillarWidth = pilar.width;
                    const pillarDepth = pilar.depth;
                    
                    const pillarVolumePerUnit = pillarWidth * pillarDepth * pilar.height;
                    totalPillarVolume += pillarVolumePerUnit * pilar.count;
                    totalPillarsCount += pilar.count;
                    
                    // Calcular sapatas se houver
                    if (pilar.hasSapata) {
                        const sapataVolume = pilar.sapataWidth * pilar.sapataLength * pilar.sapataHeight;
                        totalSapataVolume += sapataVolume * pilar.count;
                    }
                    
                    // CÁLCULO DO PRAZO DOS PILARES - CONSIDERA QUANTIDADE E ALTURA
                    const pillarProd = constructionDB.phases.structure.productivity_rules.pillar_complete_process;
                    let daysForThisPilar = pilar.count / pillarProd.team_daily_rate.avg;
                    
                    // Aumentar dias para pilares altos (acima de 2m) devido a andaime/escada
                    if (pilar.height > 2.0) {
                        daysForThisPilar *= 1.5; // +50% de tempo para andaime/escada
                    }
                    
                    // Aumentar dias para pilares mais largos/profundos
                    const pillarSizeFactor = (pillarWidth * pillarDepth) / (0.15 * 0.20); // Comparado com pilar padrão 15x20cm
                    if (pillarSizeFactor > 1.2) { // Se for 20% maior que o padrão
                        daysForThisPilar *= 1.2;
                    }
                    
                    // Ajuste por quantidade: mais pilares = mais tempo, mas com eficiência
                    if (pilar.count > 5) {
                        daysForThisPilar += (pilar.count - 5) * 0.2; // +0.2 dias para cada pilar acima de 5
                    }
                    
                    totalPillarDays += daysForThisPilar;
                });
            }
            
            // Calcular volumes de vigas
            if (inputs.includeVigas) {
                vigas.forEach(viga => {
                    const beamVolumePerMeter = viga.width * viga.height * 1;
                    totalBeamVolume += beamVolumePerMeter * viga.length;
                });
            }
            
            // Calcular volumes totais de concreto
            const totalConcreteVolume = totalPillarVolume + totalSapataVolume + totalBeamVolume;
            
            if (totalConcreteVolume > 0) {
                // Calcular materiais para concreto
                const concreteMix = constructionDB.phases.structure.materials_mix.concrete_standard;
                const cementBags = Math.ceil(totalConcreteVolume * concreteMix.yield_per_m3_final.cement_bags);
                const sandM3 = totalConcreteVolume * concreteMix.yield_per_m3_final.sand_m3;
                const gravelM3 = totalConcreteVolume * concreteMix.yield_per_m3_final.gravel_m3;
                
                // Atualizar totais
                systemState.totals.cement += cementBags;
                systemState.totals.sand += sandM3;
                systemState.totals.gravel += gravelM3;
                
                // Adicionar materiais agrupados
                // Materiais para pilares
                if (totalPillarVolume > 0) {
                    const pillarCement = Math.ceil(totalPillarVolume * concreteMix.yield_per_m3_final.cement_bags);
                    const pillarSand = totalPillarVolume * concreteMix.yield_per_m3_final.sand_m3;
                    const pillarGravel = totalPillarVolume * concreteMix.yield_per_m3_final.gravel_m3;
                    
                    systemState.materials.push({
                        phase: 'ESTRUTURA',
                        type: 'material',
                        item: 'Cimento CP II',
                        description: 'Cimento CP II para pilares',
                        unit: 'saco 50kg',
                        quantity: pillarCement
                    });
                    
                    systemState.materials.push({
                        phase: 'ESTRUTURA',
                        type: 'material',
                        item: 'Areia Média',
                        description: 'Areia média para pilares',
                        unit: 'm³',
                        quantity: pillarSand.toFixed(2)
                    });
                    
                    systemState.materials.push({
                        phase: 'ESTRUTURA',
                        type: 'material',
                        item: 'Brita 1',
                        description: 'Brita 1 para pilares',
                        unit: 'm³',
                        quantity: pillarGravel.toFixed(2)
                    });
                }
                
                // Materiais para sapatas
                if (totalSapataVolume > 0) {
                    const sapataCement = Math.ceil(totalSapataVolume * concreteMix.yield_per_m3_final.cement_bags);
                    const sapataSand = totalSapataVolume * concreteMix.yield_per_m3_final.sand_m3;
                    const sapataGravel = totalSapataVolume * concreteMix.yield_per_m3_final.gravel_m3;
                    
                    systemState.materials.push({
                        phase: 'ESTRUTURA',
                        type: 'material',
                        item: 'Cimento CP II',
                        description: 'Cimento CP II para sapatas',
                        unit: 'saco 50kg',
                        quantity: sapataCement
                    });
                    
                    systemState.materials.push({
                        phase: 'ESTRUTURA',
                        type: 'material',
                        item: 'Areia Média',
                        description: 'Areia média para sapatas',
                        unit: 'm³',
                        quantity: sapataSand.toFixed(2)
                    });
                    
                    systemState.materials.push({
                        phase: 'ESTRUTURA',
                        type: 'material',
                        item: 'Brita 1',
                        description: 'Brita 1 para sapatas',
                        unit: 'm³',
                        quantity: sapataGravel.toFixed(2)
                    });
                }
                
                // Materiais para vigas
                if (totalBeamVolume > 0) {
                    const beamCement = Math.ceil(totalBeamVolume * concreteMix.yield_per_m3_final.cement_bags);
                    const beamSand = totalBeamVolume * concreteMix.yield_per_m3_final.sand_m3;
                    const beamGravel = totalBeamVolume * concreteMix.yield_per_m3_final.gravel_m3;
                    
                    systemState.materials.push({
                        phase: 'ESTRUTURA',
                        type: 'material',
                        item: 'Cimento CP II',
                        description: 'Cimento CP II para vigas',
                        unit: 'saco 50kg',
                        quantity: beamCement
                    });
                    
                    systemState.materials.push({
                        phase: 'ESTRUTURA',
                        type: 'material',
                        item: 'Areia Média',
                        description: 'Areia média para vigas',
                        unit: 'm³',
                        quantity: beamSand.toFixed(2)
                    });
                    
                    systemState.materials.push({
                        phase: 'ESTRUTURA',
                        type: 'material',
                        item: 'Brita 1',
                        description: 'Brita 1 para vigas',
                        unit: 'm³',
                        quantity: beamGravel.toFixed(2)
                    });
                }
            }
            
            // Mão de obra para pilares
            if (totalPillarsCount > 0) {
                const pillarPricing = constructionDB.phases.structure.labor_pricing.pillar_unit;
                
                // Calcular custo total dos pilares
                let totalPillarCost = 0;
                pilares.forEach(pilar => {
                    const pillarLevel = pillarPricing.complexity_levels.find(level => level.id === pilar.type);
                    const pillarUnitPrice = pillarLevel ? pillarLevel.price_override : pillarPricing.base_price;
                    totalPillarCost += pillarUnitPrice * pilar.count;
                });
                
                systemState.financial.laborStructure += totalPillarCost;
                
                // Arredondar dias para 0.5 (meio dia) ou inteiro
                if (totalPillarDays < 0.5) {
                    totalPillarDays = 0.5;
                } else {
                    totalPillarDays = Math.ceil(totalPillarDays * 2) / 2; // Arredonda para múltiplo de 0.5
                }
                
                systemState.schedule.structure += totalPillarDays;
                
                systemState.labor.push({
                    phase: 'ESTRUTURA',
                    type: 'labor',
                    item: 'Mão de obra para pilares',
                    description: `Mão de obra para execução dos pilares (${totalPillarsCount} unidades, altura ${pilares[0].height}m)`,
                    unit: 'un',
                    quantity: totalPillarsCount,
                    unitPrice: totalPillarCost / totalPillarsCount,
                    total: totalPillarCost
                });
                
                console.log(`Prazo calculado para ${totalPillarsCount} pilares: ${totalPillarDays} dias`);
            }
            
            // Mão de obra para vigas
            if (vigas.length > 0) {
                let totalBeamLength = 0;
                let totalBeamCost = 0;
                
                vigas.forEach(viga => {
                    const beamMethod = constructionDB.phases.structure.labor_pricing.beam_linear_meter.methods.find(m => m.id === viga.type);
                    const beamUnitPrice = beamMethod ? beamMethod.price_per_m : 70;
                    const beamCost = beamUnitPrice * viga.length;
                    
                    totalBeamLength += viga.length;
                    totalBeamCost += beamCost;
                });
                
                systemState.financial.laborStructure += totalBeamCost;
                
                // Prazo para vigas: considerar 1 dia a cada 6 metros lineares
                let beamDays = Math.ceil(totalBeamLength / 6);
                // Arredondar para 0.5 se for menos de 1
                if (beamDays < 1 && totalBeamLength > 0) {
                    beamDays = 0.5;
                }
                
                systemState.schedule.structure += beamDays;
                
                systemState.labor.push({
                    phase: 'ESTRUTURA',
                    type: 'labor',
                    item: 'Mão de obra para vigas',
                    description: `Mão de obra para execução das vigas (${totalBeamLength.toFixed(1)}m lineares)`,
                    unit: 'm',
                    quantity: totalBeamLength,
                    unitPrice: totalBeamCost / totalBeamLength,
                    total: totalBeamCost
                });
            }
        }
        
        // Calcular acabamento
        function calculateFinishing(inputs, wallArea) {
            const finishingArea = wallArea * inputs.finishingFaces;
            
            // Chapisco individual (somente se marcado e não tiver reboco)
            if (inputs.chapiscoEnabled && !inputs.rebocoEnabled) {
                const chapiscoConfig = constructionDB.phases.finishing.layers.chapisco_comum;
                const cementKg = finishingArea * chapiscoConfig.consumption_per_m2.cement_kg;
                const cementBags = Math.ceil(cementKg / constructionDB.global_settings.packaging.cement_bag_kg);
                const sandM3 = finishingArea * chapiscoConfig.consumption_per_m2.sand_m3;
                
                systemState.totals.cement += cementBags;
                systemState.totals.sand += sandM3;
                
                systemState.materials.push({
                    phase: 'ACABAMENTO',
                    type: 'material',
                    item: 'Cimento CP II',
                    description: 'Cimento CP II para chapisco',
                    unit: 'saco 50kg',
                    quantity: cementBags
                });
                
                systemState.materials.push({
                    phase: 'ACABAMENTO',
                    type: 'material',
                    item: 'Areia Fina',
                    description: 'Areia fina para chapisco',
                    unit: 'm³',
                    quantity: sandM3.toFixed(3)
                });
                
                // Mão de obra para chapisco
                const laborPrice = chapiscoConfig.labor_price_market_avg.price_per_m2;
                const laborCost = finishingArea * laborPrice;
                systemState.financial.laborFinishing += laborCost;
                
                // Prazo para chapisco
                const chapiscoProd = constructionDB.phases.finishing.productivity_rules.chapisco;
                const chapiscoDays = Math.ceil(finishingArea / chapiscoProd.team_daily_rate.avg);
                systemState.schedule.finishing += chapiscoDays;
                
                systemState.labor.push({
                    phase: 'ACABAMENTO',
                    type: 'labor',
                    item: 'Mão de obra para chapisco',
                    description: `Mão de obra para chapisco (${inputs.bricklayerCount} pedreiro(s) + ${inputs.helperCount} ajudante(s))`,
                    unit: 'm²',
                    quantity: finishingArea.toFixed(1),
                    unitPrice: laborPrice,
                    total: laborCost
                });
            }
            
            // Reboco (já inclui chapisco)
            if (inputs.rebocoEnabled) {
                const rebocoConfig = constructionDB.phases.finishing.layers[
                    inputs.finishingType === 'reboco_interno' ? 'emboço_reboco_interno' : 'reboco_externo_forte'
                ];
                
                const cementKg = finishingArea * rebocoConfig.consumption_per_m2.cement_kg;
                const cementBags = Math.ceil(cementKg / constructionDB.global_settings.packaging.cement_bag_kg);
                const sandM3 = finishingArea * rebocoConfig.consumption_per_m2.sand_m3;
                const limeKg = finishingArea * rebocoConfig.consumption_per_m2.lime_kg;
                const limeBags = limeKg > 0 ? Math.ceil(limeKg / constructionDB.global_settings.packaging.lime_bag_kg) : 0;
                
                systemState.totals.cement += cementBags;
                systemState.totals.sand += sandM3;
                systemState.totals.lime += limeBags;
                
                systemState.materials.push({
                    phase: 'ACABAMENTO',
                    type: 'material',
                    item: 'Cimento CP II',
                    description: 'Cimento CP II para reboco',
                    unit: 'saco 50kg',
                    quantity: cementBags
                });
                
                systemState.materials.push({
                    phase: 'ACABAMENTO',
                    type: 'material',
                    item: 'Areia Fina',
                    description: 'Areia fina para reboco',
                    unit: 'm³',
                    quantity: sandM3.toFixed(3)
                });
                
                if (limeBags > 0) {
                    systemState.materials.push({
                        phase: 'ACABAMENTO',
                        type: 'material',
                        item: 'Cal Hidratada',
                        description: 'Cal hidratada para reboco',
                        unit: 'saco 20kg',
                        quantity: limeBags
                    });
                }
                
                // Mão de obra para reboco
                const laborPrice = rebocoConfig.labor_price_market_avg.price_per_m2;
                const laborCost = finishingArea * laborPrice;
                systemState.financial.laborFinishing += laborCost;
                
                // Prazo para reboco
                const rebocoProd = constructionDB.phases.finishing.productivity_rules.reboco;
                let rebocoDays = Math.ceil(finishingArea / rebocoProd.team_daily_rate.avg);
                
                // Garantir pelo menos 2 dias para acabamento se área for significativa
                if (rebocoDays < 2 && finishingArea > 20) {
                    rebocoDays = 2;
                }
                
                systemState.schedule.finishing = Math.max(systemState.schedule.finishing, rebocoDays);
                
                systemState.labor.push({
                    phase: 'ACABAMENTO',
                    type: 'labor',
                    item: 'Mão de obra para revestimento',
                    description: `Mão de obra para revestimento (reboco) (${inputs.bricklayerCount} pedreiro(s) + ${inputs.helperCount} ajudante(s))`,
                    unit: 'm²',
                    quantity: finishingArea.toFixed(1),
                    unitPrice: laborPrice,
                    total: laborCost
                });
            }
        }
        
        // Calcular prazos com margem técnica e sobreposição
        function calculateSchedule(inputs) {
            console.log('Iniciando calculateSchedule:', {
                inputsMasonryDays: inputs.masonryDays,
                systemMasonryDays: systemState.schedule.masonry
            });
            
            // Obter prazos atuais do sistema (sem margem aplicada ainda)
            let masonryDays = systemState.schedule.masonry || 0;
            let structureDays = systemState.schedule.structure || 0;
            let finishingDays = systemState.schedule.finishing || 0;
            
            console.log('Dias após pegar do systemState:', { masonryDays, structureDays, finishingDays });
            
            // Se o usuário informou prazos manualmente, substituir os calculados
            if (inputs.masonryDays > 0) {
                masonryDays = inputs.masonryDays;
            }
            
            if (inputs.structureDays > 0) {
                structureDays = inputs.structureDays;
            }
            
            if (inputs.finishingDays > 0) {
                finishingDays = inputs.finishingDays;
            }
            
            console.log('Dias após considerar inputs manuais:', { masonryDays, structureDays, finishingDays });
            
            // Aplicar margem de segurança APENAS se os dias não foram informados manualmente
            // E limitar a margem a no máximo 30% (0.3) para evitar erros
            let safetyMargin = constructionDB.global_settings?.schedule_rules?.safety_margin_days?.max || 0.2;
            
            // CORREÇÃO: Limitar a margem a no máximo 30% para evitar erros no JSON
            if (safetyMargin > 0.3) {
                safetyMargin = 0.2; // Usar 20% como padrão seguro
                console.warn('Margem de segurança ajustada de', constructionDB.global_settings?.schedule_rules?.safety_margin_days?.max, 'para', safetyMargin);
            }
            
            console.log('Margem de segurança usada:', safetyMargin);
            
            // Aplicar margem APENAS se não foi informado manualmente e se há dias para aplicar
            if (inputs.masonryDays <= 0 && masonryDays > 0) {
                masonryDays = Math.ceil(masonryDays * (1 + safetyMargin));
            }
            
            if (inputs.structureDays <= 0 && structureDays > 0) {
                structureDays = Math.ceil(structureDays * (1 + safetyMargin));
                
                // Garantir pelo menos +1 dia para estrutura complexa (com pilares/vigas)
                if (structureDays < 2 && (inputs.includePillars || inputs.includeVigas)) {
                    structureDays = 2;
                }
            }
            
            if (inputs.finishingDays <= 0 && finishingDays > 0) {
                finishingDays = Math.ceil(finishingDays * (1 + safetyMargin));
            }
            
            console.log('Dias após aplicar margem de segurança:', { masonryDays, structureDays, finishingDays });
            
            // Considerar sobreposição: estrutura pode começar enquanto termina a alvenaria
            // Mas não somamos simplesmente, usamos o máximo entre eles mais o acabamento
            const maxConcurrentDays = Math.max(masonryDays, structureDays);
            const totalDays = maxConcurrentDays + finishingDays;
            
            console.log('Dias finais:', {
                masonryDays,
                structureDays,
                finishingDays,
                totalDays
            });
            
            systemState.schedule.masonry = masonryDays;
            systemState.schedule.structure = structureDays;
            systemState.schedule.finishing = finishingDays;
            systemState.schedule.total = totalDays;
            
            // Atualizar input de prazo total
            const totalDaysInput = document.getElementById('total-days-input');
            if (totalDaysInput) {
                totalDaysInput.value = totalDays;
            }
        }
        
        // Calcular finanças
        function calculateFinancials(inputs) {
            systemState.financial.subtotal = 
                systemState.financial.laborMasonry + 
                systemState.financial.laborStructure + 
                systemState.financial.laborFinishing;
            
            systemState.financial.profit = systemState.financial.subtotal * (inputs.profitMargin / 100);
            systemState.financial.total = systemState.financial.subtotal + systemState.financial.profit;
        }
        
        // Atualizar tabela de resultados
        function updateResults() {
            const tableBody = document.getElementById('results-table');
            tableBody.innerHTML = '';
            
            let itemNumber = 1;
            
            // Fase: ALVENARIA
            if (systemState.materials.filter(m => m.phase === 'ALVENARIA').length > 0 || 
                systemState.labor.filter(l => l.phase === 'ALVENARIA').length > 0) {
                
                // Cabeçalho da fase
                const phaseHeader = document.createElement('tr');
                phaseHeader.className = 'phase-header';
                phaseHeader.innerHTML = `
                    <td colspan="6">
                        <i class="fas fa-cubes mr-2"></i>ALVENARIA - MURO
                    </td>
                `;
                tableBody.appendChild(phaseHeader);
                
                // Materiais da alvenaria
                systemState.materials.filter(m => m.phase === 'ALVENARIA').forEach(material => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="font-medium">${itemNumber}</td>
                        <td>${material.description}</td>
                        <td>${material.unit}</td>
                        <td class="editable-cell" onclick="editCell(this, '${material.phase}', '${material.description}', 'quantity')">
                            ${material.quantity}
                        </td>
                        <td></td>
                        <td></td>
                    `;
                    tableBody.appendChild(row);
                    itemNumber++;
                });
                
                // Mão de obra da alvenaria
                systemState.labor.filter(l => l.phase === 'ALVENARIA').forEach(laborItem => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="font-medium">${itemNumber}</td>
                        <td>${laborItem.description}</td>
                        <td>${laborItem.unit}</td>
                        <td>${laborItem.quantity}</td>
                        <td>${formatCurrency(laborItem.unitPrice)}</td>
                        <td>${formatCurrency(laborItem.total)}</td>
                    `;
                    tableBody.appendChild(row);
                    itemNumber++;
                });
                
                // Subtotal da fase
                const subtotalRow = document.createElement('tr');
                subtotalRow.className = 'subtotal-row';
                subtotalRow.innerHTML = `
                    <td colspan="5" class="text-right font-medium">Subtotal Alvenaria (Muro):</td>
                    <td class="font-medium">${formatCurrency(systemState.financial.laborMasonry)}</td>
                `;
                tableBody.appendChild(subtotalRow);
                
                // Linha em branco
                const blankRow = document.createElement('tr');
                blankRow.innerHTML = '<td colspan="6" style="height: 15px; background: #f8fafc;"></td>';
                tableBody.appendChild(blankRow);
            }
            
            // Fase: ESTRUTURA
            if (systemState.materials.filter(m => m.phase === 'ESTRUTURA').length > 0 || 
                systemState.labor.filter(l => l.phase === 'ESTRUTURA').length > 0) {
                
                // Cabeçalho da fase
                const phaseHeader = document.createElement('tr');
                phaseHeader.className = 'phase-header';
                phaseHeader.innerHTML = `
                    <td colspan="6">
                        <i class="fas fa-grip-vertical mr-2"></i>ESTRUTURA (FUNDAÇÃO + PILARES/VIGAS)
                    </td>
                `;
                tableBody.appendChild(phaseHeader);
                
                // Materiais da estrutura
                systemState.materials.filter(m => m.phase === 'ESTRUTURA').forEach(material => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="font-medium">${itemNumber}</td>
                        <td>${material.description}</td>
                        <td>${material.unit}</td>
                        <td class="editable-cell" onclick="editCell(this, '${material.phase}', '${material.description}', 'quantity')">
                            ${material.quantity}
                        </td>
                        <td></td>
                        <td></td>
                    `;
                    tableBody.appendChild(row);
                    itemNumber++;
                });
                
                // Mão de obra da estrutura
                systemState.labor.filter(l => l.phase === 'ESTRUTURA').forEach(laborItem => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="font-medium">${itemNumber}</td>
                        <td>${laborItem.description}</td>
                        <td>${laborItem.unit}</td>
                        <td>${laborItem.quantity}</td>
                        <td>${formatCurrency(laborItem.unitPrice)}</td>
                        <td>${formatCurrency(laborItem.total)}</td>
                    `;
                    tableBody.appendChild(row);
                    itemNumber++;
                });
                
                // Subtotal da fase
                const subtotalRow = document.createElement('tr');
                subtotalRow.className = 'subtotal-row';
                subtotalRow.innerHTML = `
                    <td colspan="5" class="text-right font-medium">Subtotal Estrutura:</td>
                    <td class="font-medium">${formatCurrency(systemState.financial.laborStructure)}</td>
                `;
                tableBody.appendChild(subtotalRow);
                
                // Linha em branco
                const blankRow = document.createElement('tr');
                blankRow.innerHTML = '<td colspan="6" style="height: 15px; background: #f8fafc;"></td>';
                tableBody.appendChild(blankRow);
            }
            
            // Fase: ACABAMENTO
            if (systemState.materials.filter(m => m.phase === 'ACABAMENTO').length > 0 || 
                systemState.labor.filter(l => l.phase === 'ACABAMENTO').length > 0) {
                
                // Cabeçalho da fase
                const phaseHeader = document.createElement('tr');
                phaseHeader.className = 'phase-header';
                phaseHeader.innerHTML = `
                    <td colspan="6">
                        <i class="fas fa-trowel mr-2"></i>ACABAMENTO
                    </td>
                `;
                tableBody.appendChild(phaseHeader);
                
                // Materiais do acabamento
                systemState.materials.filter(m => m.phase === 'ACABAMENTO').forEach(material => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="font-medium">${itemNumber}</td>
                        <td>${material.description}</td>
                        <td>${material.unit}</td>
                        <td class="editable-cell" onclick="editCell(this, '${material.phase}', '${material.description}', 'quantity')">
                            ${material.quantity}
                        </td>
                        <td></td>
                        <td></td>
                    `;
                    tableBody.appendChild(row);
                    itemNumber++;
                });
                
                // Mão de obra do acabamento
                systemState.labor.filter(l => l.phase === 'ACABAMENTO').forEach(laborItem => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="font-medium">${itemNumber}</td>
                        <td>${laborItem.description}</td>
                        <td>${laborItem.unit}</td>
                        <td>${laborItem.quantity}</td>
                        <td>${formatCurrency(laborItem.unitPrice)}</td>
                        <td>${formatCurrency(laborItem.total)}</td>
                    `;
                    tableBody.appendChild(row);
                    itemNumber++;
                });
                
                // Subtotal da fase
                const subtotalRow = document.createElement('tr');
                subtotalRow.className = 'subtotal-row';
                subtotalRow.innerHTML = `
                    <td colspan="5" class="text-right font-medium">Subtotal Acabamento:</td>
                    <td class="font-medium">${formatCurrency(systemState.financial.laborFinishing)}</td>
                `;
                tableBody.appendChild(subtotalRow);
            }
            
            // Linha Total Geral
            const totalRow = document.createElement('tr');
            totalRow.className = 'total-row';
            totalRow.innerHTML = `
                <td colspan="5" class="text-right font-bold">TOTAL GERAL DO PROJETO:</td>
                <td class="font-bold text-lg">${formatCurrency(systemState.financial.total)}</td>
            `;
            tableBody.appendChild(totalRow);
        }
        
        // Editar célula
        function editCell(cell, phase, itemName, field) {
            if (editingCell) return;
            
            const currentValue = cell.textContent.trim();
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'editable-input';
            input.value = currentValue;
            
            cell.innerHTML = '';
            cell.appendChild(input);
            input.focus();
            
            editingCell = { cell, phase, itemName, field };
            
            input.addEventListener('blur', saveEdit);
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') saveEdit();
            });
        }
        
        // Salvar edição
        function saveEdit() {
            if (!editingCell) return;
            
            const input = editingCell.cell.querySelector('input');
            if (!input) return;
            
            const newValue = input.value;
            editingCell.cell.textContent = newValue;
            
            // Atualizar estado do sistema
            if (editingCell.field === 'quantity') {
                // Encontrar o material correto e atualizar
                const materialIndex = systemState.materials.findIndex(m => 
                    m.phase === editingCell.phase && m.description === editingCell.itemName
                );
                
                if (materialIndex !== -1) {
                    systemState.materials[materialIndex].quantity = newValue;
                    updateMaterialSummary();
                }
            }
            
            editingCell = null;
        }
        
        // Editar quantidade de material no resumo
        function editMaterialQuantity(elementId) {
            const element = document.getElementById(elementId);
            const currentText = element.textContent;
            const [currentValue, unit] = currentText.split(' ');
            
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'editable-input';
            input.value = currentValue;
            input.style.width = '80px';
            input.style.textAlign = 'right';
            
            element.innerHTML = '';
            element.appendChild(input);
            input.focus();
            
            input.addEventListener('blur', function() {
                element.textContent = `${input.value} ${unit}`;
                // Atualizar cálculos
                calculateProject();
            });
            
            input.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    element.textContent = `${input.value} ${unit}`;
                    // Atualizar cálculos
                    calculateProject();
                }
            });
        }
        
        // Atualizar resumo de materiais
        function updateMaterialSummary() {
            // Obter os valores dos inputs primeiro
            const inputs = getInputValues();
            
            // Elementos de materiais
            const cementEl = document.getElementById('total-cement');
            const sandEl = document.getElementById('total-sand');
            const gravelEl = document.getElementById('total-gravel');
            const limeEl = document.getElementById('total-lime');
            const bricksEl = document.getElementById('total-bricks');
            const totalDaysEl = document.getElementById('total-days');
            const totalDaysSummaryEl = document.getElementById('total-days-summary');
            
            if (cementEl) cementEl.textContent = `${systemState.totals.cement} sacos`;
            if (sandEl) sandEl.textContent = `${systemState.totals.sand.toFixed(2)} m³`;
            if (gravelEl) gravelEl.textContent = `${systemState.totals.gravel.toFixed(2)} m³`;
            if (limeEl) limeEl.textContent = `${systemState.totals.lime} sacos`;
            if (bricksEl) bricksEl.textContent = `${systemState.totals.bricks} un`;
            if (totalDaysEl) totalDaysEl.textContent = `${systemState.schedule.total} dias`;
            if (totalDaysSummaryEl) totalDaysSummaryEl.textContent = `${systemState.schedule.total} dias`;
            
            // Elementos financeiros
            const laborMasonryEl = document.getElementById('labor-masonry');
            const laborStructureEl = document.getElementById('labor-structure');
            const laborFinishingEl = document.getElementById('labor-finishing');
            const subtotalLaborEl = document.getElementById('subtotal-labor');
            const profitPercentEl = document.getElementById('profit-percent');
            const profitValueEl = document.getElementById('profit-value');
            const totalProjectEl = document.getElementById('total-project');
            
            if (laborMasonryEl) laborMasonryEl.textContent = formatCurrency(systemState.financial.laborMasonry);
            if (laborStructureEl) laborStructureEl.textContent = formatCurrency(systemState.financial.laborStructure);
            if (laborFinishingEl) laborFinishingEl.textContent = formatCurrency(systemState.financial.laborFinishing);
            if (subtotalLaborEl) subtotalLaborEl.textContent = formatCurrency(systemState.financial.subtotal);
            if (profitPercentEl) profitPercentEl.textContent = `${Math.round(inputs.profitMargin)}%`;
            if (profitValueEl) profitValueEl.textContent = formatCurrency(systemState.financial.profit);
            if (totalProjectEl) totalProjectEl.textContent = formatCurrency(systemState.financial.total);
            
            // Atualizar informações da equipe
            const masonryTeamEl = document.getElementById('masonry-team');
            const structureTeamEl = document.getElementById('structure-team');
            const finishingTeamEl = document.getElementById('finishing-team');
            
            if (masonryTeamEl) masonryTeamEl.textContent = `${inputs.bricklayerCount} pedreiro(s) + ${inputs.helperCount} ajudante(s)`;
            if (structureTeamEl) structureTeamEl.textContent = `${inputs.bricklayerCount} pedreiro(s) + ${inputs.helperCount} ajudante(s)`;
            if (finishingTeamEl) finishingTeamEl.textContent = `${inputs.bricklayerCount} pedreiro(s) + ${inputs.helperCount} ajudante(s)`;
            
            // Atualizar descrições de prazos
            const masonryDaysEl = document.getElementById('masonry-days');
            const structureDaysEl = document.getElementById('structure-days');
            const finishingDaysEl = document.getElementById('finishing-days');
            
            if (masonryDaysEl) masonryDaysEl.textContent = `${systemState.schedule.masonry} dias`;
            if (structureDaysEl) structureDaysEl.textContent = `${systemState.schedule.structure} dias`;
            if (finishingDaysEl) finishingDaysEl.textContent = `${systemState.schedule.finishing} dias`;
            
            systemState.lastCalculation = inputs;
        }
        
        // Formatar moeda
        function formatCurrency(value) {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            }).format(value);
        }
        
        // Salvar orçamento
        function saveEstimate() {
            if (!systemState.lastCalculation) {
                alert('Por favor, calcule o projeto primeiro.');
                return;
            }
            
            const estimateData = {
                title: `Muro ${systemState.lastCalculation.wallLength}m × ${systemState.lastCalculation.wallHeight}m`,
                type: 'alvenaria',
                date: new Date().toLocaleDateString('pt-BR'),
                time: new Date().toLocaleTimeString('pt-BR'),
                description: `Construção de muro em alvenaria`,
                materials: systemState.materials,
                labor: systemState.labor,
                totals: systemState.totals,
                schedule: systemState.schedule,
                financial: systemState.financial,
                inputs: systemState.lastCalculation,
                timestamp: new Date().toISOString(),
                total: systemState.financial.total.toLocaleString('pt-BR', {
                    style: 'currency',
                    currency: 'BRL'
                })
            };
            
            // Salvar no localStorage para a página de orçamentos
            localStorage.setItem('importedServiceData', JSON.stringify(estimateData));
            
            // Redirecionar para a página de orçamentos
            setTimeout(() => {
                window.close();
            }, 1000);
            
            // Mostrar mensagem
            alert('Orçamento salvo! Voltando para a página principal...');
        }
    </script>
</body>
</html>